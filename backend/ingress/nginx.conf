events {
    worker_connections 1024;
}

http {
    upstream auth {
        server auth:5000;
    }

    upstream roadmap {
        server roadmap:5001;
    }

    upstream profile {
        server profile:5002;
    }

    upstream post {
        server post:5003;
    }

    upstream notification {
        server notification:5004;
    }

    upstream chat {
        server chat:5005;
    }

    upstream recommendation {
        server recommendation:5006;
    }

    server {
        listen 80;

        location /auth/ {
            proxy_pass http://auth/;
        }

        location /roadmap/ {
            proxy_pass http://roadmap/;
        }

        location /profile/ {
            proxy_pass http://profile/;
        }

        location /post/ {
            proxy_pass http://post/;
        }

        location /notification/ {
            proxy_pass http://notification/;
        }

        location /chat/ {
            proxy_pass http://chat/;
        }

        location /recommendation/ {
            proxy_pass http://recommendation/;
        }

        # CORS configuration
        add_header 'Access-Control-Allow-Origin' '$http_origin' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' '*' always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '$http_origin' always;
            add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, PATCH, OPTIONS' always;
            add_header 'Access-Control-Allow-Headers' '*' always;
            add_header 'Access-Control-Allow-Credentials' 'true' always;
            add_header 'Content-Type' 'text/plain charset=UTF-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }
}